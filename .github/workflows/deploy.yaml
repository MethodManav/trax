name: Deploy

on:
  push:
    branches:
      - main
    paths:
      - "trax-backend/**"

  workflow_dispatch:
    inputs:
      versionName:
        description: "Version Name to deploy"
        required: true
      versionDescription:
        description: "Version Description to deploy"
        required: true

env:
  MOTIA_API_KEY: ${{ secrets.MOTIA_API_KEY }}
  MOTIA_ENV_ID: ${{ secrets.MOTIA_ENV_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    defaults:
      run:
        working-directory: trax-backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set VERSION_NAME and DESCRIPTION
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION_NAME=${{ github.event.inputs.versionName }}" >> $GITHUB_ENV
            echo "VERSION_DESCRIPTION=${{ github.event.inputs.versionDescription }}" >> $GITHUB_ENV
          else
            echo "VERSION_NAME=${GITHUB_SHA::7}" >> $GITHUB_ENV
            echo "VERSION_DESCRIPTION=${{ github.event.head_commit.message }}" >> $GITHUB_ENV
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: trax-backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Create Env file
        run: |
          echo "DB_URL=${{ secrets.DB_URL }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "MOTIA_API_KEY=${{ secrets.MOTIA_API_KEY }}" >> .env
          echo "MOTIA_ENV_ID=${{ secrets.MOTIA_ENV_ID }}" >> .env

      - name: Deploy using Motia Cloud
        run: |
          npx motia cloud deploy \
            --api-key "$MOTIA_API_KEY" \
            --environment-id "$MOTIA_ENV_ID" \
            --version-name "$VERSION_NAME" \
            --version-description "$VERSION_DESCRIPTION" \
            --env-file .env
